<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A rusty conjugate gradient - Daniel Vainsencher</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="iterative_methods_part_1.html"><strong aria-hidden="true">1.</strong> A rusty conjugate gradient</a></li><li class="chapter-item expanded affix "><a href="about.html">About</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Daniel Vainsencher</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#iterative-methods-in-rust-conjugate-gradient" id="iterative-methods-in-rust-conjugate-gradient">Iterative methods in Rust: conjugate gradient</a></h1>
<h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Conjugate_gradient_method">Conjugate
gradients</a>
(CG) is an iterative method for solving \(Ax = b\). It is limited to
the case where the matrix \(A\) is <em>positive definite</em><sup class="footnote-reference"><a href="#PD">1</a></sup> which
occurs often, for example, in
<a href="https://en.wikipedia.org/wiki/Finite_element_method">FEM</a> simulators
of physics on complex shapes. By <a href="https://en.wikipedia.org/wiki/Iterative_method">iterative
method</a> we mean a
simple recipe to improve an approximate solution, which we apply
repeatedly starting from some initial value. While iterative methods
are not the bread and butter of CS courses or interview questions, in
many domains they are so much more scalable than alternatives they are
essentially the only game in town. From deep learning to PageRank,
iterative methods power many magical-seeming uses of computers. This
series is a tour behind the curtain; today's post introduces their
implemention and some software engineering considerations, using CG as
our example.</p>
<p>Implementing an iterative method often starts as a for loop around the
recipe, but that loop body accumulates cruft like you wouldn't believe
(hmm, is it working? let's print an indication of progress...). I'd
gotten used to writing these over and over and dreaming about better
design when I read a beautiful
<a href="https://lostella.github.io/2018/07/25/iterative-methods-done-right.html">post</a>
by Lorenzo Stella. Titled &quot;Iterative Methods Done Right&quot; (IMDR), it
proposes to use a Julia iterable to abstract each iterative algorithm,
and also a reusable &quot;utility&quot; for each of those pesky recurring
worries I mentioned.</p>
<p>Could such a reusable vocabulary work for Rust as well? How far could
it go? Rust abstracts loops via iterators and custom abstractions are
idiomatic, its worth a try. I decided to follow in their footsteps,
and essentially transcribed their design to Rust using
<a href="https://github.com/rust-ndarray/ndarray">ndarray</a>.</p>
<div class="footnote-definition" id="PD"><sup class="footnote-definition-label">1</sup>
<p>Positive Definite matrices</p>
</div>
<p>A positive definite matrix \(A\) only scales \(x\)s
differently in different directions; no rotation or flipping allowed.</p>
<h2><a class="header" href="#implementation-and-a-general-interface" id="implementation-and-a-general-interface">Implementation and a general interface</a></h2>
<p>My (almost) first implementation ended up looking like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        let ap = self.a.dot(&amp;self.p).into_shared();
        let alpha = self.rs / self.p.dot(&amp;ap);
        self.x += &amp;(alpha * &amp;self.p);
        self.r -= &amp;(alpha * &amp;ap);
        self.rsprev = self.rs;
        self.rs = self.r.dot(&amp;self.r);
        self.p = (&amp;self.r + &amp;(&amp;self.rs / self.rsprev * &amp;self.p)).into_shared();
        self.ap = Some(ap);
<span class="boring">}
</span></code></pre></pre>
<p>which is quite similar to their Julia version (itself very similar to
the wikipedia rendition), except for being more explicit about memory
usage. </p>
<p>Following IMDR, we define a struct <code>CGIterable</code> whose fields hold
almost all intermediate state of the algorithm. A function takes a
problem (in this case, \((A,b)\)) and returns a CGIterable, for which
we implement the StreamingIterator trait. </p>
<p>This trait is simple, and requires us to implement two methods:</p>
<ul>
<li><code>advance</code> applies one iteration of the algorithm via the code above</li>
<li><code>get</code> borrows <code>self</code> and return <code>Some(self)</code>. </li>
</ul>
<p><code>get</code> returning the struct by reference is the main motivation to use
StreamingIterator over the ubiquitous Iterator trait; it leaves
decisions to copy state up to the implementor.</p>
<p>The signatures for implementing an iterative method in this style are as follows:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The state of a conjugate gradient algorithm.
#[derive(Clone)]
struct CGIterable {
    // contents
}

impl CGIterable {
    /// Convert a LinearSystem problem into a StreamingIterator of conjugate gradient solutions.
    pub fn conjugate_gradient(problem: LinearSystem) -&gt; CGIterable {
	    // we chose to consume the LinearSystem, but it can probably be borrowed instead
    }
}

impl StreamingIterator for CGIterable {
    type Item = CGIterable;
    /// Implementation of conjugate gradient iteration
    fn advance(&amp;mut self) {
	    // the improvement recipe goes here
    }
    fn get(&amp;self) -&gt; Option&lt;&amp;Self::Item&gt; {
	    // We will eventually change this, but for now:
        Some(self)
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#running-an-iterative-method" id="running-an-iterative-method">Running an iterative method</a></h2>
<p>How do we call such an implementation?</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// First we generate a problem, which consists of the pair (A,b).
let p = make_3x3_psd_system_2();

// Next convert it into an iterator
let cg_iter = CGIterable::conjugate_gradient(p);

// and loop over intermediate solutions.
// Note `next` is provided by the StreamingIterator trait using
// `advance` then `get`.
while let Some(result) = cg_print_iter.next() {
	// We want to find x such that a.dot(x) = b
	// then the difference between the two sides (called the residual),
	// is a good measure of the error in a solution.
	let res = result.a.dot(&amp;result.x) - &amp;result.b;
	
	// The (squared) length of the residual is a number summarizing
	// how bad a solution is. When working on iterative methods,
	// we want to see these number decrease quickly.
	let res_squared_length = res.dot(&amp;res);
	
    println!(
        &quot;||Ax - b||_2 = {:.5}, for x = {:.4}&quot;,
        res_squared_length,
		result.x,
}
<span class="boring">}
</span></code></pre></pre>
<p>Indeed the output shows nice convergence, with the residual \(Ax -
b\) tending quickly to zero:</p>
<pre><code>||Ax - b||_2 = 1.00000, for x = [0.0000, 1.0000, 0.0000]
||Ax - b||_2 = 0.06250, for x = [-0.6250, 1.3125, -0.6250]
||Ax - b||_2 = 0.00391, for x = [-0.6641, 1.3320, -0.6641]
||Ax - b||_2 = 0.00024, for x = [-0.6665, 1.3333, -0.6665]
||Ax - b||_2 = 0.00002, for x = [-0.6667, 1.3333, -0.6667]
</code></pre>
<p>In terms of the code, notice we've nicely taken the algorithm out of
the loop, but the loop body is now dominated by the progress
report. Also the loop is currently infinite, so we still owe some
stopping logic if we want it to stop on its own. Once we start looking
for these niceties, soon we'll want to:</p>
<ul>
<li>look at only every Nth iteration,</li>
<li>time the cost of an iteration (but not auxiliary I/O!), </li>
<li>plot progress over time,</li>
<li>save progress so we can restart if electricity failed...</li>
</ul>
<p>and we certainly don't want all of those tangled in our loop. Such
functionality will be useful next time we write an iterative methods,
we'll want to reuse them! IMDR proposes a nice solution, which we will
demonstrate in Rust in the next post. Beyond code reuse, benchmarking
and testing are very important for iterative methods. How does one
test the properties of code that doesn't really want to stop, and for
which solutions only approach correctness?</p>
<p>We'll get into those questions and more over the next few posts.</p>
<hr />
<p>Thanks to Daniel Fox, a collaborator on this project.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        
                            <a rel="next" href="about.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
                    <a rel="next" href="about.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3031/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
